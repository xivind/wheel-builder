{% extends "base.html" %}

{% block title %}Component Library - Wheel Builder{% endblock %}

{% block content %}
<div class="container pb-5">
    <!-- Page Header -->
    <div class="row mb-5 align-items-center">
        <div class="col">
            <h1 class="display-5 fw-bold text-dark mb-2">Component Library</h1>
            <p class="text-muted lead mb-0">Manage your inventory of hubs, rims, spokes, and nipples</p>
        </div>
    </div>

    <!-- Tabs for different component types -->
    <ul class="nav nav-tabs mb-4" id="componentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="hubs-tab" data-bs-toggle="tab" data-bs-target="#hubs" type="button" role="tab">
                Hubs <span class="badge bg-primary">{{ hubs|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rims-tab" data-bs-toggle="tab" data-bs-target="#rims" type="button" role="tab">
                Rims <span class="badge bg-primary">{{ rims|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="spokes-tab" data-bs-toggle="tab" data-bs-target="#spokes" type="button" role="tab">
                Spokes <span class="badge bg-primary">{{ spokes|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="nipples-tab" data-bs-toggle="tab" data-bs-target="#nipples" type="button" role="tab">
                Nipples <span class="badge bg-primary">{{ nipples|length }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="componentTabContent">
        <!-- Hubs Tab -->
        <div class="tab-pane fade show active" id="hubs" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa; border-bottom: 2px solid var(--secondary-color);">
                    <span style="font-weight: 600; color: var(--primary-color);">Hub Library</span>
                    <button class="btn btn-primary btn-sm"
                            hx-get="/partials/hub-form"
                            hx-target="#component-modal-container"
                            hx-swap="innerHTML"
                            
                            >
                        <i class="bi bi-plus-lg"></i> Add New Hub
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th>Make</th>
                                    <th>Model</th>
                                    <th>Type</th>
                                    <th>OLD</th>
                                    <th>Left Flange Ø</th>
                                    <th>Right Flange Ø</th>
                                    <th>Left Offset</th>
                                    <th>Right Offset</th>
                                    <th>Hole Ø</th>
                                    <th>Spokes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for hub in hubs %}
                                <tr>
                                    <td>
                                        {% if hub.locked %}
                                            <i class="bi bi-lock-fill text-warning" title="Used by {{ hub.used_by_builds|length }} build(s)"></i>
                                        {% endif %}
                                        {{ hub.make }}
                                    </td>
                                    <td>{{ hub.model }}</td>
                                    <td><span class="badge bg-{% if hub.type == 'front' %}info{% else %}success{% endif %}">{{ hub.type|title }}</span></td>
                                    <td>{{ hub.old }}</td>
                                    <td>{{ hub.left_flange_diameter }}</td>
                                    <td>{{ hub.right_flange_diameter }}</td>
                                    <td>{{ hub.left_flange_offset }}</td>
                                    <td>{{ hub.right_flange_offset }}</td>
                                    <td>{{ hub.spoke_hole_diameter }}</td>
                                    <td>{{ hub.number_of_spokes if hub.number_of_spokes else '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                hx-get="/partials/hub-form?id={{ hub.id }}"
                                                hx-target="#component-modal-container"
                                                hx-swap="innerHTML"
                                                
                                                
                                                {% if hub.locked %}disabled title="Cannot edit - used by {{ hub.used_by_builds|length }} build(s)"{% else %}title="Edit"{% endif %}>
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <form method="POST" action="/config/hub/{{ hub.id }}/delete" style="display: inline;" class="delete-form" data-item-type="hub" data-item-name="{{ hub.make }} {{ hub.model }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    {% if hub.locked %}disabled title="Cannot delete - used by {{ hub.used_by_builds|length }} build(s)"{% else %}title="Delete"{% endif %}>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if not hubs %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No hubs found. Click "Add New Hub" to get started.
                        </div>
                        {% endif %}
                        <p class="text-muted small mb-0 mt-2">
                            <i class="bi bi-lock-fill text-warning"></i> Locked items are currently in use by builds and cannot be edited or deleted. All measurements are in mm.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rims Tab -->
        <div class="tab-pane fade" id="rims" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa; border-bottom: 2px solid var(--secondary-color);">
                    <span style="font-weight: 600; color: var(--primary-color);">Rim Library</span>
                    <button class="btn btn-primary btn-sm"
                            hx-get="/partials/rim-form"
                            hx-target="#component-modal-container"
                            hx-swap="innerHTML"
                            
                            >
                        <i class="bi bi-plus-lg"></i> Add New Rim
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th>Make</th>
                                    <th>Model</th>
                                    <th>Type</th>
                                    <th>ERD</th>
                                    <th>OSB</th>
                                    <th>Inner Width</th>
                                    <th>Outer Width</th>
                                    <th>Holes</th>
                                    <th>Material</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rim in rims %}
                                <tr>
                                    <td>
                                        {% if rim.locked %}
                                            <i class="bi bi-lock-fill text-warning" title="Used by {{ rim.used_by_builds|length }} build(s)"></i>
                                        {% endif %}
                                        {{ rim.make }}
                                    </td>
                                    <td>{{ rim.model }}</td>
                                    <td><span class="badge bg-{% if rim.type == 'symmetric' %}info{% else %}warning text-dark{% endif %}">{{ rim.type|title }}</span></td>
                                    <td>{{ rim.erd }}</td>
                                    <td>{{ rim.osb }}</td>
                                    <td>{{ rim.inner_width }}</td>
                                    <td>{{ rim.outer_width }}</td>
                                    <td>{{ rim.holes }}</td>
                                    <td>{{ rim.material|title }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                hx-get="/partials/rim-form?id={{ rim.id }}"
                                                hx-target="#component-modal-container"
                                                hx-swap="innerHTML"
                                                
                                                
                                                {% if rim.locked %}disabled title="Cannot edit - used by {{ rim.used_by_builds|length }} build(s)"{% else %}title="Edit"{% endif %}>
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <form method="POST" action="/config/rim/{{ rim.id }}/delete" style="display: inline;" class="delete-form" data-item-type="rim" data-item-name="{{ rim.make }} {{ rim.model }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    {% if rim.locked %}disabled title="Cannot delete - used by {{ rim.used_by_builds|length }} build(s)"{% else %}title="Delete"{% endif %}>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if not rims %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No rims found. Click "Add New Rim" to get started.
                        </div>
                        {% endif %}
                        <p class="text-muted small mb-0 mt-2">
                            <i class="bi bi-lock-fill text-warning"></i> Locked items are currently in use by builds and cannot be edited or deleted. All measurements are in mm.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spokes Tab -->
        <div class="tab-pane fade" id="spokes" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa; border-bottom: 2px solid var(--secondary-color);">
                    <span style="font-weight: 600; color: var(--primary-color);">Spoke Library</span>
                    <button class="btn btn-primary btn-sm"
                            hx-get="/partials/spoke-form"
                            hx-target="#component-modal-container"
                            hx-swap="innerHTML"
                            
                            >
                        <i class="bi bi-plus-lg"></i> Add New Spoke
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th>Spoke Type</th>
                                    <th>Properties</th>
                                    <th>Tension Range (kgf)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for spoke in spokes %}
                                <tr>
                                    <td>
                                        {% if spoke.locked %}
                                            <i class="bi bi-lock-fill text-warning" title="Used by {{ spoke.used_by_builds|length }} build(s)"></i>
                                        {% endif %}
                                        {{ spoke.spoke_type.name }} @ {{ spoke.length }}mm
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ spoke.spoke_type.material }}</span>
                                        <span class="badge bg-info">{{ spoke.spoke_type.dimensions }}</span>
                                    </td>
                                    <td>{{ spoke.spoke_type.min_tension_kgf }} - {{ spoke.spoke_type.max_tension_kgf }} kgf</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                hx-get="/partials/spoke-form?id={{ spoke.id }}"
                                                hx-target="#component-modal-container"
                                                hx-swap="innerHTML"


                                                {% if spoke.locked %}disabled title="Cannot edit - used by {{ spoke.used_by_builds|length }} build(s)"{% else %}title="Edit"{% endif %}>
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <form method="POST" action="/config/spoke/{{ spoke.id }}/delete" style="display: inline;" class="delete-form" data-item-type="spoke" data-item-name="{{ spoke.spoke_type.name }} @ {{ spoke.length }}mm">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    {% if spoke.locked %}disabled title="Cannot delete - used by {{ spoke.used_by_builds|length }} build(s)"{% else %}title="Delete"{% endif %}>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if not spokes %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No spokes found. Click "Add New Spoke" to get started.
                        </div>
                        {% endif %}
                        <p class="text-muted small mb-0 mt-2">
                            <i class="bi bi-lock-fill text-warning"></i> Locked items are currently in use by builds and cannot be edited or deleted.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nipples Tab -->
        <div class="tab-pane fade" id="nipples" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa; border-bottom: 2px solid var(--secondary-color);">
                    <span style="font-weight: 600; color: var(--primary-color);">Nipple Library</span>
                    <button class="btn btn-primary btn-sm"
                            hx-get="/partials/nipple-form"
                            hx-target="#component-modal-container"
                            hx-swap="innerHTML"
                            
                            >
                        <i class="bi bi-plus-lg"></i> Add New Nipple
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th>Material</th>
                                    <th>Diameter</th>
                                    <th>Length</th>
                                    <th>Color</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for nipple in nipples %}
                                <tr>
                                    <td>
                                        {% if nipple.locked %}
                                            <i class="bi bi-lock-fill text-warning" title="Used by {{ nipple.used_by_builds|length }} build(s)"></i>
                                        {% endif %}
                                        {{ nipple.material|title }}
                                    </td>
                                    <td>{{ nipple.diameter }}</td>
                                    <td>{{ nipple.length }}</td>
                                    <td>{{ nipple.color|title }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                hx-get="/partials/nipple-form?id={{ nipple.id }}"
                                                hx-target="#component-modal-container"
                                                hx-swap="innerHTML"
                                                
                                                
                                                {% if nipple.locked %}disabled title="Cannot edit - used by {{ nipple.used_by_builds|length }} build(s)"{% else %}title="Edit"{% endif %}>
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <form method="POST" action="/config/nipple/{{ nipple.id }}/delete" style="display: inline;" class="delete-form" data-item-type="nipple" data-item-name="{{ nipple.material|title }} {{ nipple.diameter }}mm">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    {% if nipple.locked %}disabled title="Cannot delete - used by {{ nipple.used_by_builds|length }} build(s)"{% else %}title="Delete"{% endif %}>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if not nipples %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No nipples found. Click "Add New Nipple" to get started.
                        </div>
                        {% endif %}
                        <p class="text-muted small mb-0 mt-2">
                            <i class="bi bi-lock-fill text-warning"></i> Locked items are currently in use by builds and cannot be edited or deleted. All measurements are in mm.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Container -->
<div class="modal fade" id="component-modal" tabindex="-1">
    <div id="component-modal-container"></div>
</div>

<style>
.nav-tabs .nav-link {
    color: var(--primary-color);
}

.nav-tabs .nav-link.active {
    color: var(--secondary-color);
    font-weight: 600;
}

.table th {
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}
</style>

<script>
// Activate the correct tab based on URL hash on page load
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash) {
        const tabId = hash.substring(1); // Remove the '#'
        const tabButton = document.getElementById(tabId + '-tab');
        if (tabButton) {
            const tab = new bootstrap.Tab(tabButton);
            tab.show();
        }
    }

    // Handle delete confirmations for all component types
    const deleteForms = document.querySelectorAll('.delete-form');
    deleteForms.forEach(function(form) {
        form.addEventListener('submit', async function(e) {
            // Don't prevent submit if button is disabled (locked items)
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton && submitButton.disabled) {
                return;
            }

            e.preventDefault();
            const itemType = form.getAttribute('data-item-type');
            const itemName = form.getAttribute('data-item-name');
            const confirmed = await showConfirmModal(
                'Are you sure you want to delete this ' + itemType + ' (' + itemName + ')?'
            );
            if (confirmed) {
                this.submit();
            }
        });
    });
});
</script>
{% endblock %}
