# Wheel Builder Application - Design Document

**Date:** 2025-11-15
**Status:** Approved
**Version:** 1.0

## Overview

A self-hosted web application to help bicycle wheel builders select components, calculate spoke lengths, track tension measurements, and visualize build quality over time.

## Key Requirements

- Single user application (no authentication needed)
- Responsive design (works on mobile)
- Component library management (hubs, rims, spokes, nipples)
- Spoke length calculation using provided formulas
- Tension tracking with versioned sessions
- Quality analysis and visualization
- Component locking to preserve build history

## Technology Stack

- **Backend:** FastAPI
- **Database:** SQLite with PeeWee ORM
- **Frontend:** Bootstrap 5, HTMX, Jinja2 templates
- **JavaScript:** Vanilla JS in single file (app.js)
- **Libraries:**
  - TomSelect for advanced dropdowns
  - Tempus Dominus for date/time pickers
  - Chart.js for radar charts
- **Deployment:** Docker container, port 8004
- **Data Persistence:** External SQLite database mounted from host

## Database Schema

### Component Library Tables

**Hub**
- `id` (UUID, generated by utils.generate_uuid())
- `make` (string)
- `model` (string)
- `type` (string: "front" or "rear")
- `old` (float: over locknut distance in mm)
- `left_flange_diameter` (float: mm)
- `right_flange_diameter` (float: mm)
- `left_flange_offset` (float: mm)
- `right_flange_offset` (float: mm)
- `spoke_hole_diameter` (float: mm)

**Rim**
- `id` (UUID)
- `make` (string)
- `model` (string)
- `type` (string: "symmetric" or "asymmetric")
- `erd` (float: effective rim diameter in mm)
- `osb` (float: offset spoke bed in mm, 0 for symmetric)
- `inner_width` (float: mm)
- `outer_width` (float: mm)
- `holes` (integer: number of spoke holes)
- `material` (string: "aluminum", "carbon", "steel")

**Spoke**
- `id` (UUID)
- `material` (string)
- `gauge` (string: e.g., "2.0 mm", "2.0/1.8/2.0 mm")
- `max_tension` (float: kgf)
- `length` (float: mm)

**Nipple**
- `id` (UUID)
- `material` (string)
- `diameter` (float: mm)
- `length` (float: mm)
- `color` (string)

### Wheel Build Tables

**WheelBuild**
- `id` (UUID)
- `name` (string, required)
- `status` (string: "draft", "in_progress", "completed" - user-controlled)
- `hub_id` (UUID, FK to Hub, optional)
- `rim_id` (UUID, FK to Rim, optional)
- `spoke_id` (UUID, FK to Spoke, optional)
- `nipple_id` (UUID, FK to Nipple, optional)
- `lacing_pattern` (string: "radial", "1-cross", "2-cross", "3-cross", "4-cross", optional)
- `spoke_count` (integer, optional)
- `actual_spoke_length_left` (float: mm, optional)
- `actual_spoke_length_right` (float: mm, optional)
- `comments` (text, optional)
- `created_at` (datetime)
- `updated_at` (datetime)

**TensionSession**
- `id` (UUID)
- `wheel_build_id` (UUID, FK to WheelBuild)
- `session_name` (string: e.g., "Initial", "After First True", "After 500km")
- `session_date` (datetime)
- `notes` (text, optional)
- `created_at` (datetime)

**TensionReading**
- `id` (UUID)
- `tension_session_id` (UUID, FK to TensionSession)
- `spoke_number` (integer: 1-N)
- `side` (string: "left" or "right")
- `tm_reading` (float: Park Tool TM-1 reading)
- `estimated_tension_kgf` (float: calculated tension in kgf)
- `range_status` (string: "in_range", "over", "under" - checks against recommended min/max)
- `average_deviation_status` (string: "in_range", "over", "under" - checks against ±20% of side average)

### Component Locking

- Components cannot be edited or deleted if referenced by any WheelBuild
- `database_manager.py` provides: `get_builds_using_component(component_id)` → list of builds
- `business_logic.py` checks this and adds `locked: true` flag to response
- Frontend disables edit/delete buttons and shows warning banner listing affected builds

## Application Architecture

### Layer Separation

**main.py - Routing Layer**
- FastAPI application initialization
- Route definitions only (no business logic)
- Request/response handling
- Serves Jinja2 templates
- Example routes:
  - `GET /` → dashboard
  - `GET /build/{id}` → build details
  - `POST /build/create` → create build
  - `GET /config` → configuration page

**business_logic.py - Calculation & Orchestration**
- Spoke length calculations
- Tension range calculations
- Quality indicators
- Statistics (average, std deviation, ±20% limits)
- Component locking checks
- Validation logic
- Orchestrates all CRUD via database_manager
- Never accesses database directly

**database_manager.py - Data Access Layer**
- All CRUD operations
- Queries for component usage
- Returns PeeWee model instances
- Methods: `create_wheel_build()`, `get_all_builds()`, `create_tension_session()`, etc.

**database_model.py - ORM Models**
- PeeWee model definitions
- No backrefs (per constraint)
- Simple, clean relationships

**utils.py - Helper Functions**
- `generate_uuid()` - creates UUIDs for all records
- Other utility functions as needed

**logger.py - Logging Configuration**
- Unified logging for FastAPI and Python modules
- Logs to Docker container stdout/stderr

## Frontend Architecture

### Template Structure

**base.html**
- Navigation bar
- Common CSS/JS includes (Bootstrap, HTMX, TomSelect, Tempus Dominus, Chart.js)
- Footer
- All pages extend via Jinja2 inheritance

**dashboard.html**
- Stats overview (total builds, completed, in progress)
- Search/filter controls
- Grid of wheel build cards
- Floating action button for "New Build"

**build_details.html**
- Build information section (editable)
- Tension session selector
- Tension readings table (left/right sides)
- Radar chart visualization
- Quality indicators panel
- Summary statistics
- Actions (edit, add session, duplicate, delete)

**config.html**
- Tabs for Hubs/Rims/Spokes/Nipples/Settings
- Tables with Add/Edit/Delete actions
- Modal forms for adding/editing
- Locking warnings for in-use components

### HTMX Usage Patterns

1. **Dashboard Updates:**
   - Search/filter → updates card grid
   - New Build button → loads modal form

2. **Build Details Dynamic Features:**
   - Add tension reading → updates table + chart
   - Change session → swaps table content
   - Comparison mode → loads difference view

3. **Configuration:**
   - Add/Edit forms → modal submission
   - Delete → confirmation with locking check

### JavaScript (app.js)

Single file containing:
- Chart.js radar chart initialization
- TomSelect initialization for dropdowns
- Tempus Dominus date picker setup
- Form validation helpers
- No inline JavaScript in templates

## Business Logic & Calculations

### Spoke Length Calculation

**Function:** `calculate_spoke_length(hub, rim, spoke, nipple, spoke_count, lacing_pattern, side)`

- Uses provided formulas
- Inputs: hub dimensions, rim ERD, spoke gauge, nipple length, lacing pattern
- Returns: recommended spoke length for left and right sides separately
- Called when all component data is present

### Tension Recommendations

**Function:** `calculate_tension_range(spoke, rim)`

- Uses spoke max_tension and rim material
- Returns: min/max tension in kgf and Park Tool TM-1 readings
- Considers spoke gauge and material strength

### Tension Analysis

For each side (left/right) separately:

**Functions:**
- `calculate_average_tension(readings, side)` → average kgf
- `calculate_std_deviation(readings, side)` → consistency metric
- `calculate_tolerance_limits(average)` → ±20% bounds
- `check_range_status(reading, min, max)` → in_range/over/under
- `check_average_deviation_status(reading, average, tolerance)` → in_range/over/under

### Quality Indicators

- **"Well Balanced"**: All spokes within recommended range and ±20%
- **"Needs Truing"**: Some spokes outside ±20% tolerance
- **"Uneven Tension"**: High standard deviation

### Validation Logic

**Function:** `can_calculate_spoke_length(wheel_build)`

- Checks if hub, rim, spoke, nipple, lacing_pattern, spoke_count are all set
- Returns: boolean + list of missing fields
- Used to show warnings: "Cannot calculate spoke length - missing spoke selection"

### Session Comparison

**Function:** `compare_tension_sessions(session_id, baseline_session_id)`

- Difference view: shows one session with deltas from baseline
- Returns readings with:
  - Delta values (kgf)
  - Visual indicators (tighter/looser/same)
  - Color coding for easy scanning

## User Workflows

### Dashboard Page (/)

1. User lands on dashboard showing all wheel builds
2. Stats overview shows totals and averages
3. Search/filter updates grid via HTMX
4. Click card → navigate to build details
5. Click FAB "+" → HTMX modal for new build
6. Create form: name required, other fields optional
7. Submit creates build with status="draft"

### Build Details Page (/build/{id})

1. Top section shows build info and status badge
2. User can change status via dropdown (draft/in_progress/completed)
3. Component specs section (editable if no tension sessions yet)
4. Warnings shown if data incomplete for calculations
5. Tension session selector (dropdown)
6. "Add New Session" button → modal with name + date
7. Tension readings table with inline or bulk entry
8. Quality indicators update as readings saved
9. Comparison toggle → difference view vs baseline

### Configuration Page (/config)

1. Tabs for each component type + Settings
2. Each tab shows table of components
3. Add button → modal form with TomSelect dropdowns
4. Edit locked component → inputs disabled, warning banner
5. Delete locked component → modal prevents deletion
6. All forms validate before submission

## API Routes & Endpoints

### Page Routes (GET - render templates)
- `GET /` → dashboard.html
- `GET /build/{id}` → build_details.html
- `GET /config` → config.html

### Wheel Build Routes
- `POST /build/create` → create build
- `POST /build/{id}/update` → update build
- `DELETE /build/{id}` → delete build
- `GET /build/{id}/edit` → edit form partial (HTMX)

### Tension Session Routes
- `POST /build/{id}/session/create` → new session
- `GET /build/{id}/session/{session_id}` → session table partial (HTMX)
- `POST /session/{session_id}/readings` → bulk save readings
- `GET /session/{session_id}/compare/{baseline_id}` → difference view (HTMX)

### Component Configuration Routes
- `POST /config/hub` → add hub
- `PUT /config/hub/{id}` → update hub (checks locking)
- `DELETE /config/hub/{id}` → delete hub (checks locking)
- Similar routes for rim, spoke, nipple

### HTMX Partial Routes
- `GET /partials/build-card-grid?search=...` → filtered cards
- `GET /partials/build-form` → create/edit modal
- `GET /partials/session-form` → add session modal

### Response Types
- Full pages: Jinja2 templates
- HTMX updates: HTML fragments
- Errors: JSON or HTML based on HX-Request header

## Docker Deployment

### Dockerfile
- Base: `python:3.11-slim`
- Install dependencies via requirements.txt
- Copy application code
- Expose port 8004
- CMD: `uvicorn main:app --host 0.0.0.0 --port 8004`

### Deployment Script (create-container-wheelbuilder.sh)
```bash
#!/bin/bash
set -o xtrace

# Cleanup
docker container stop wheel-builder
docker container rm wheel-builder
docker image rm wheel-builder

# Build
docker build -t wheel-builder .

# Create data directory
mkdir -p ~/code/container_data

# Run container
docker run -d \
  --name=wheel-builder \
  -e TZ=Europe/Stockholm \
  -v ~/code/container_data:/app/data \
  --restart unless-stopped \
  -p 8004:8004 \
  wheel-builder
```

### Database Configuration
- Database file: `/app/data/wheel_builder.db`
- Environment variable: `DATABASE_PATH` (defaults to above)
- On startup:
  - Check if database exists
  - If not: create schema, run seed_data.py
  - If exists: connect and continue

### Seed Data (seed_data.py)

Populates component library with examples:

**Hubs (~5 examples):**
- Shimano Alfine SG-S700
- DT Swiss 350
- Hope Pro 4
- Shimano Ultegra
- Phil Wood Track

**Rims (~5 examples):**
- Ryde Andra 30
- Mavic Open Pro
- DT Swiss XM 481
- Stan's Grail
- H+Son Archetype

**Spokes (~4 types):**
- Steel 2.0mm straight gauge
- Stainless 2.0/1.8/2.0 double-butted
- Steel 1.8mm straight gauge
- Titanium 2.0mm straight gauge

**Nipples (~4 types):**
- Brass standard (various sizes)
- Aluminum standard (various sizes)

All with complete metadata for calculations.

Idempotent: checks by make+model before inserting.

### Backup Strategy
- User copies `~/code/container_data/wheel_builder.db` from host
- Future: JSON export functionality

## Error Handling

### Validation Warnings (soft)
- Yellow alert box when calculations can't run
- Example: "Spoke length cannot be calculated - select all components"
- User can still save incomplete builds

### Component Locking (blocking)
- Banner message: "This hub is used in: [Build 1], [Build 2]. Cannot edit."
- Form inputs disabled
- Delete button hidden or disabled

### Form Validation (client & server)
- Red inline messages for invalid fields
- Client-side: HTML5 validation + JavaScript
- Server-side: business_logic validates all inputs

### Server Errors
- Toast notifications for unexpected errors
- Log to container stdout/stderr via logger.py
- Graceful degradation (HTMX falls back to full page)

## Development Constraints

1. **No inline JavaScript**: All JS in /static/js/app.js
2. **No auto-generated IDs**: Use utils.generate_uuid()
3. **No backrefs in ORM**: Keep models simple
4. **Layer separation strict**:
   - main.py → routing only
   - business_logic.py → calculations and logic
   - database_manager.py → CRUD only
5. **External SQLite**: Mounted from host filesystem

## Future Enhancements (Out of Scope)

- Multi-user support with authentication
- JSON export/import of builds
- Print-friendly build reports
- Mobile app (native)
- Advanced charting (lateral/radial trueness)
- Component inventory tracking

## Success Criteria

1. User can manage component library (add/edit/delete with locking)
2. User can create wheel builds with minimal info (name only)
3. User can fill in component details progressively
4. Spoke length calculations work when all data present
5. User can create multiple tension sessions per build
6. Tension readings saved and analyzed (range + ±20% checks)
7. Quality indicators display correctly
8. Session comparison shows difference view
9. Docker deployment works with external database
10. Data persists across container restarts
11. Responsive design works on mobile
12. All JavaScript in single file
